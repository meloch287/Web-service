# Web-service-main (Учебный проект на Грант) 

## Обзор проекта

`Web-service-main` - это комплексное решение для симуляции и обработки финансовых транзакций, включающее в себя модули для отправки, получения и обнаружения аномалий. Проект разработан с использованием Python и Flask, а для хранения данных используется PostgreSQL. 

## Компоненты

Проект состоит из следующих основных компонентов:

### 1. `receiver.py` (Сервис Получатель)

Flask-приложение, которое выступает в роли конечной точки для приема транзакционных данных. 

**Основные функции:**
- Принимает входящие запросы с данными транзакций в форматах JSON и XML.
- Сохраняет как исходные сообщения, так и разобранные данные транзакций в базу данных PostgreSQL.
- Динамически создает необходимые таблицы (`transactions`, `clients`, `transaction_types`, `banks`, `transaction_status`) при первом запуске, если они отсутствуют.
- Интегрируется с модулем `anomaly_detection.py` для анализа каждой входящей транзакции на предмет аномалий.
- Логирует все входящие запросы и результаты обработки.

**Технологии:** Flask, SQLAlchemy, Psycopg2, xmltodict.

### 2. `sender.py` (Сервис Отправитель)

Flask-приложение, предназначенное для отправки транзакционных данных на сервис-получатель.

**Основные функции:**
- Принимает запросы на отправку данных, содержащие полезную нагрузку (`data`) и желаемый формат (`format` - JSON или XML).
- Преобразует данные в указанный формат (JSON или XML).
- Отправляет данные на конечную точку `/receive` сервиса-получателя с механизмом повторных попыток при сбоях.
- Логирует процесс отправки и ответы от сервиса-получателя.

**Технологии:** Flask, requests, dicttoxml.

### 3. `anomaly_detection.py` (Модуль Обнаружения Аномалий)

Модуль, отвечающий за выявление подозрительных транзакций на основе различных критериев.

**Основные функции:**
- Подключается к базе данных PostgreSQL для получения исторической информации о транзакциях.
- Реализует несколько алгоритмов обнаружения аномалий:
    - **Частота транзакций:** Проверяет, не превышает ли количество транзакций от одного клиента заданный порог за определенный временной интервал.
    - **Необычная сумма:** Определяет, отличается ли сумма текущей транзакции от исторического среднего для данного клиента на заданное количество стандартных отклонений.
    - **Необычное направление:** Выявляет транзакции, направленные на ранее неизвестных получателей для данного отправителя.
    - **История клиента:** Оценивает подозрительность клиента на основе доли плохих транзакций в его истории.
- Рассчитывает общий "скор аномальности" для каждой транзакции, комбинируя результаты всех проверок.
- Обновляет статус транзакции в базе данных, помечая ее как "плохую" (is_bad) и добавляя детали анализа.

**Технологии:** Psycopg2, datetime.

### 4. `scripts/` (Вспомогательные скрипты и утилиты)

Директория `scripts/` содержит набор утилит для генерации данных, отправки транзакций и визуализации.

- **`db_config.py`**: Управление подключением к базе данных PostgreSQL, включая инициализацию пула соединений и закрытие.
- **`user_generator.py`**: Генерирует случайных пользователей и сохраняет их в базу данных.
- **`transaction_generator.py`**: Создает синтетические транзакции, включая моделирование аномалий (высокие суммы, необычные направления, подозрительные клиенты) и сохраняет их в JSON-файлы.
- **`transaction_sender.py`**: Отправляет сгенерированные транзакции на сервис `sender.py`, поддерживая параллельную отправку и симуляцию временных задержек.
- **`validation.py`**: Содержит функции для валидации данных пользователей и транзакций.
- **`visualization.py`**: Предоставляет инструменты для визуализации данных, включая графики ожидаемой и фактической нагрузки транзакций, а также распределение аномалий.
- **`main.py`**: Основной скрипт для запуска всей симуляции. Он инициализирует базу данных, генерирует пользователей и транзакции, отправляет их через `sender.py` и визуализирует результаты.

## Установка и Запуск

### Требования

- Python 3.x
- PostgreSQL

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Настройка Базы Данных

Убедитесь, что у вас установлен и запущен PostgreSQL. Создайте пользователя и базу данных, как указано в `receiver.py` (по умолчанию `DB_USER="vtsk"`, `DB_PASSWORD="1234"`, `DB_HOST="localhost"`, `DB_PORT="5432"`, `DB_NAME="vtsk_db"`).

### Запуск Сервисов

1. **Запуск Receiver (Сервис Получатель):**
   ```bash
   python receiver.py
   ```
   Сервис будет доступен по адресу `http://0.0.0.0:5001`.

2. **Запуск Sender (Сервис Отправитель):**
   ```bash
   python sender.py
   ```
   Сервис будет доступен по адресу `http://0.0.0.0:5000`.

### Запуск Симуляции (Генерация и Отправка Транзакций)

После запуска `receiver.py` и `sender.py`, вы можете запустить симуляцию:

```bash
python -m scripts.main
```

Этот скрипт сгенерирует пользователей и транзакции, отправит их через `sender.py` на `receiver.py`, и отобразит графики нагрузки и аномалий.

## Структура Проекта

```
Web-service-main/
├── anomaly_detection.py
├── receiver.py
├── requirements.txt
├── sender.py
├── scripts/
│   ├── __init__.py
│   ├── db_config.py
│   ├── main.py
│   ├── payload_template.json
│   ├── transaction_generator.py
│   ├── transaction_sender.py
│   ├── user_generator.py
│   ├── validation.py
│   └── visualization.py
└── README.md
```

## Логирование

- `receiver.log`: Логи сервиса `receiver.py`.
- `sender.log`: Логи сервиса `sender.py`.
- `anomaly_detection.log`: Логи модуля `anomaly_detection.py`.
- `script.log`: Логи основного скрипта симуляции (`scripts/main.py`).

## Авторы

meloch287



